{% extends "base.html" %}

{% block title %}{{ prd.project_name }} - PRD{% endblock %}

{% block content %}
<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: #00ff00; margin: 0;">
            > {{ prd.project_name }}
        </h2>
        <div>
            <a href="{{ url_for('list_prds') }}" class="btn">[BACK]</a>
            <button onclick="downloadJSON()" class="btn" style="margin-left: 10px;">[DOWNLOAD JSON]</button>
            <button onclick="downloadMarkdown()" class="btn" style="margin-left: 10px;">[DOWNLOAD MD]</button>
        </div>
    </div>

    <div style="background: #0a0a0a; border: 1px solid #00ff00; padding: 15px; margin-bottom: 20px;">
        <p style="color: #888; margin: 5px 0; font-size: 12px;">
            ID: <code>{{ prd.id }}</code>
        </p>
        <p style="color: #888; margin: 5px 0; font-size: 12px;">
            Created: {{ prd.created_at }}
        </p>
    </div>

    <!-- PRD Content -->
    <div class="prd-display">
<pre style="margin: 0;">
<span style="color: #00ffff;">PROJECT NAME:</span> {{ prd.project_name }}

<span style="color: #00ffff;">DESCRIPTION:</span>
{{ prd.project_description }}

<span style="color: #00ffff;">STARTER PROMPT:</span>
{{ prd.starter_prompt }}

<span style="color: #00ffff;">TECH STACK:</span>
{% for key, value in prd.tech_stack.items() %}
  {{ key }}: {{ value }}
{% endfor %}

<span style="color: #00ffff;">FILE STRUCTURE:</span>
{% for file in prd.file_structure %}
  - {{ file }}
{% endfor %}

<span style="color: #00ffff;">TASKS:</span>
{% for cat_id, category in prd.prds.items() %}
<span style="color: #ff00ff;">━━━ {{ category.n }} [{{ cat_id }}] ━━━</span>
{% for task in category.t %}
  <span style="color: #ffff00;">[{{ task.id }}] [{{ task.pr }}]</span> {{ task.ti }}
  → {{ task.d }}
  → File: {{ task.f }}

{% endfor %}
{% endfor %}
</pre>
    </div>

    <!-- Task Summary -->
    <div style="margin-top: 20px;">
        <h3 style="color: #00ff00;">> TASK SUMMARY</h3>
        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
            <tr style="border-bottom: 1px solid #00ff00;">
                <th style="color: #00ff00; text-align: left; padding: 10px;">Category</th>
                <th style="color: #00ff00; text-align: center; padding: 10px;">Critical</th>
                <th style="color: #00ff00; text-align: center; padding: 10px;">High</th>
                <th style="color: #00ff00; text-align: center; padding: 10px;">Medium</th>
                <th style="color: #00ff00; text-align: center; padding: 10px;">Low</th>
                <th style="color: #00ff00; text-align: center; padding: 10px;">Total</th>
            </tr>
            {% for cat_id, category in prd.prds.items() %}
            <tr style="border-bottom: 1px solid #333;">
                <td style="color: #00ffff; padding: 10px;">{{ category.n }}</td>
                <td style="color: #ff0000; text-align: center;">{{ category.t | selectattr('pr', 'equalto', 'critical') | list | length }}</td>
                <td style="color: #ffaa00; text-align: center;">{{ category.t | selectattr('pr', 'equalto', 'high') | list | length }}</td>
                <td style="color: #ffff00; text-align: center;">{{ category.t | selectattr('pr', 'equalto', 'medium') | list | length }}</td>
                <td style="color: #00ff00; text-align: center;">{{ category.t | selectattr('pr', 'equalto', 'low') | list | length }}</td>
                <td style="color: #00ffff; text-align: center;">{{ category.t | length }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const prdData = {{ prd_dict | safe }};

function downloadJSON() {
    const blob = new Blob([JSON.stringify(prdData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `prd-{{ prd.project_name | replace(' ', '_') }}.json`;
    a.click();
}

function downloadMarkdown() {
    const prd = prdData;
    let md = `# ${prd.pn}\n\n`;
    md += `**Description:** ${prd.pd}\n\n`;
    md += `## Starter Prompt\n\n${prd.sp}\n\n`;
    md += `## Tech Stack\n\n`;
    md += `- Language: ${prd.ts.lang || 'N/A'}\n`;
    md += `- Framework: ${prd.ts.fw || 'N/A'}\n`;
    md += `- Database: ${prd.ts.db || 'N/A'}\n`;
    if (prd.ts.oth) {
        md += `- Other: ${prd.ts.oth.join(', ')}\n`;
    }
    md += `\n## File Structure\n\n`;
    prd.fs.forEach(f => md += `- \`${f}\`\n`);
    md += `\n## Tasks\n\n`;

    for (const [cat_id, cat] of Object.entries(prd.p)) {
        md += `### ${cat.n} [${cat_id}]\n\n`;
        cat.t.forEach(task => {
            md += `#### ${task.id} [${task.pr}]\n\n`;
            md += `**${task.ti}**\n\n`;
            md += `- Description: ${task.d}\n`;
            md += `- File: \`${task.f}\`\n\n`;
        });
    }

    const blob = new Blob([md], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `prd-${prd.pn || 'untitled'}.md`;
    a.click();
}
</script>
{% endblock %}
