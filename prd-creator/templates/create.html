{% extends "base.html" %}

{% block title %}Create PRD - Ralph Mode PRD Creator{% endblock %}

{% block content %}
<div class="container">
    <h2 style="color: #00ff00; border-bottom: 1px solid #00ff00; padding-bottom: 10px;">
        > CREATE NEW PRD
    </h2>

    <!-- Settings Panel -->
    <div class="settings-panel">
        <h3 style="color: #00ff00; margin-top: 0;">> CONFIGURATION</h3>
        <div class="settings-row">
            <div class="settings-col">
                <div class="form-group">
                    <label>AI MODEL</label>
                    <select id="model-select">
                        <option value="llama3.2">LLaMA 3.2 (Local)</option>
                        <option value="llama3.1">LLaMA 3.1 (Local)</option>
                        <option value="grok-2">Grok-2 (API)</option>
                    </select>
                </div>
            </div>
            <div class="settings-col">
                <div class="form-group">
                    <label>TASK COUNT</label>
                    <select id="task-count">
                        <option value="20">20 tasks (Quick)</option>
                        <option value="34" selected>34 tasks (Standard)</option>
                        <option value="50">50 tasks (Comprehensive)</option>
                    </select>
                </div>
            </div>
            <div class="settings-col">
                <div class="form-group">
                    <label>TECH STACK</label>
                    <select id="tech-stack">
                        <option value="python-flask">Python + Flask</option>
                        <option value="python-fastapi">Python + FastAPI</option>
                        <option value="javascript-node">JavaScript + Node</option>
                        <option value="rust-axum">Rust + Axum</option>
                        <option value="go-gin">Go + Gin</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- PRD Form -->
    <form id="prd-form">
        <div class="form-group">
            <label for="project-name">PROJECT NAME</label>
            <input type="text" id="project-name" name="project_name" required
                   placeholder="e.g., My Awesome Project"
                   maxlength="100">
        </div>

        <div class="form-group">
            <label for="description">PROJECT DESCRIPTION</label>
            <textarea id="description" name="description" rows="3" required
                      placeholder="Briefly describe what your project does..."
                      maxlength="1000"></textarea>
        </div>

        <div class="form-group">
            <label for="starter-prompt">STARTER IDEA / PROMPT</label>
            <textarea id="starter-prompt" name="starter_prompt" rows="6" required
                      placeholder="Describe your project idea in detail. What problem does it solve? What are the main features?..."
                      maxlength="10000"></textarea>
        </div>

        <!-- OCR Upload -->
        <div class="form-group">
            <label>UPLOAD IMAGE (OPTIONAL - OCR EXTRACTION)</label>
            <div class="file-upload" id="file-upload">
                <p style="margin: 0; color: #00ff00;">
                    [DRAG & DROP or CLICK to upload]<br>
                    <small>Supported: PNG, JPG, PDF (max 5MB)</small>
                </p>
                <input type="file" id="file-input" accept=".png,.jpg,.jpeg,.pdf" style="display: none;">
            </div>
            <div id="file-info" style="margin-top: 10px; color: #00ffff; display: none;">
                > File selected: <span id="file-name"></span>
            </div>
        </div>

        <div style="margin-top: 30px;">
            <button type="submit" class="btn" id="generate-btn">
                [ GENERATE PRD ]
            </button>
            <button type="button" class="btn" id="clear-btn" style="margin-left: 10px;">
                [ CLEAR ]
            </button>
        </div>
    </form>

    <!-- Progress Indicator -->
    <div id="progress" style="display: none; margin-top: 30px;">
        <p style="color: #00ffff;">
            > <span class="loading">GENERATING PRD</span> - This may take a moment...
        </p>
        <div style="width: 100%; height: 20px; border: 1px solid #00ff00; margin-top: 10px;">
            <div id="progress-bar" style="width: 0%; height: 100%; background: #00ff00; transition: width 0.3s;"></div>
        </div>
        <p id="progress-status" style="color: #00ff00; margin-top: 10px;">Initializing...</p>
    </div>

    <!-- Error Display -->
    <div id="error-display" class="error-message" style="display: none;"></div>

    <!-- Result Display -->
    <div id="result-display" style="display: none; margin-top: 30px;">
        <h3 style="color: #00ff00;">> PRD GENERATED SUCCESSFULLY</h3>
        <p style="color: #00ffff;">ID: <span id="prd-id"></span></p>

        <div style="margin-top: 20px;">
            <button class="btn" onclick="viewPRD()">[ VIEW PRD ]</button>
            <button class="btn" onclick="downloadJSON()" style="margin-left: 10px;">[ DOWNLOAD JSON ]</button>
            <button class="btn" onclick="downloadMarkdown()" style="margin-left: 10px;">[ DOWNLOAD MARKDOWN ]</button>
            <a href="{{ url_for('create_prd') }}" class="btn" style="margin-left: 10px;">[ CREATE ANOTHER ]</a>
        </div>

        <!-- PRD Preview -->
        <details style="margin-top: 20px;">
            <summary style="color: #00ff00; cursor: pointer;">[ SHOW PREVIEW ]</summary>
            <div class="prd-display" id="prd-preview"></div>
        </details>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let uploadedText = '';
let currentPRD = null;

// File upload handling
const fileUpload = document.getElementById('file-upload');
const fileInput = document.getElementById('file-input');

fileUpload.addEventListener('click', () => fileInput.click());
fileUpload.addEventListener('dragover', (e) => {
    e.preventDefault();
    fileUpload.classList.add('dragover');
});
fileUpload.addEventListener('dragleave', () => {
    fileUpload.classList.remove('dragover');
});
fileUpload.addEventListener('drop', (e) => {
    e.preventDefault();
    fileUpload.classList.remove('dragover');
    handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', (e) => {
    handleFile(e.target.files[0]);
});

async function handleFile(file) {
    if (!file) return;

    document.getElementById('file-info').style.display = 'block';
    document.getElementById('file-name').textContent = file.name;

    // Upload for OCR processing
    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('/api/ocr', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) throw new Error('OCR failed');

        const data = await response.json();
        uploadedText = data.text || '';

        if (uploadedText) {
            document.getElementById('starter-prompt').value = uploadedText;
            showStatus('> OCR extraction complete! Text extracted from image.', 'success');
        }
    } catch (error) {
        showStatus('> OCR failed: ' + error.message, 'error');
    }
}

// Form submission
document.getElementById('prd-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const data = {
        project_name: document.getElementById('project-name').value,
        description: document.getElementById('description').value,
        starter_prompt: document.getElementById('starter-prompt').value,
        model: document.getElementById('model-select').value,
        task_count: parseInt(document.getElementById('task-count').value),
        tech_stack: document.getElementById('tech-stack').value
    };

    // Show progress
    document.getElementById('progress').style.display = 'block';
    document.getElementById('generate-btn').disabled = true;
    updateProgress(10, 'Connecting to model...');
    document.getElementById('error-display').style.display = 'none';
    document.getElementById('result-display').style.display = 'none';

    try {
        updateProgress(30, 'Generating PRD structure...');

        const response = await fetch('/api/prd/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        updateProgress(70, 'Processing response...');

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Generation failed');
        }

        currentPRD = await response.json();

        updateProgress(100, 'Complete!');

        // Show result
        document.getElementById('prd-id').textContent = currentPRD.id;
        document.getElementById('prd-preview').textContent = JSON.stringify(currentPRD.prd, null, 2);
        document.getElementById('result-display').style.display = 'block';

    } catch (error) {
        document.getElementById('error-display').textContent = '> ERROR: ' + error.message;
        document.getElementById('error-display').style.display = 'block';
    } finally {
        document.getElementById('progress').style.display = 'none';
        document.getElementById('generate-btn').disabled = false;
    }
});

function updateProgress(percent, status) {
    document.getElementById('progress-bar').style.width = percent + '%';
    document.getElementById('progress-status').textContent = status;
}

function showStatus(message, type) {
    // Could add a toast notification here
    console.log(message);
}

function viewPRD() {
    if (currentPRD) {
        window.location.href = '/prd/' + currentPRD.id;
    }
}

function downloadJSON() {
    if (!currentPRD) return;
    const blob = new Blob([JSON.stringify(currentPRD.prd, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `prd-${currentPRD.project_name || 'untitled'}.json`;
    a.click();
}

function downloadMarkdown() {
    if (!currentPRD) return;

    const prd = currentPRD.prd;
    let md = `# ${prd.pn}\n\n`;
    md += `**Description:** ${prd.pd}\n\n`;
    md += `**Tech Stack:** ${JSON.stringify(prd.ts)}\n\n`;
    md += `## File Structure\n\n`;
    prd.fs.forEach(f => md += `- ${f}\n`);
    md += `\n## Tasks\n\n`;

    for (const [cat_id, cat] of Object.entries(prd.p)) {
        md += `### ${cat.n}\n\n`;
        cat.t.forEach(task => {
            md += `- **${task.id}** [${task.pr}]: ${task.ti}\n`;
            md += `  - ${task.d}\n`;
            md += `  - File: ${task.f}\n\n`;
        });
    }

    const blob = new Blob([md], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `prd-${prd.pn || 'untitled'}.md`;
    a.click();
}

// Clear form
document.getElementById('clear-btn').addEventListener('click', () => {
    document.getElementById('prd-form').reset();
    uploadedText = '';
    currentPRD = null;
    document.getElementById('file-info').style.display = 'none';
    document.getElementById('error-display').style.display = 'none';
    document.getElementById('result-display').style.display = 'none';
});
</script>
{% endblock %}
