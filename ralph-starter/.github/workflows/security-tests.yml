name: Security Tests (SEC-003 CSRF Protection)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  csrf-protection-tests:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.9, 3.10, 3.11]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flask flask-cors pytest pytest-cov
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Run CSRF protection tests
      run: |
        python test_csrf_protection.py

    - name: Run pytest with coverage
      run: |
        pytest test_csrf_protection.py --cov=api_server --cov-report=html --cov-report=term
      continue-on-error: true

    - name: Upload coverage report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: coverage-report-${{ matrix.python-version }}
        path: htmlcov/

    - name: Security check - CSRF implementation
      run: |
        echo "Checking CSRF implementation..."
        python -c "
        import sys
        sys.path.insert(0, '.')
        from api_server import CSRFProtection, app

        # Verify CSRF protection class exists
        assert hasattr(CSRFProtection, 'generate_token'), 'CSRF token generation missing'
        assert hasattr(CSRFProtection, 'validate_token'), 'CSRF token validation missing'
        assert hasattr(CSRFProtection, 'validate_origin'), 'Origin validation missing'
        assert hasattr(CSRFProtection, 'validate_double_submit_cookie'), 'Double-submit validation missing'

        # Verify Flask security settings
        assert app.config.get('SESSION_COOKIE_SECURE'), 'Session cookies must be Secure'
        assert app.config.get('SESSION_COOKIE_HTTPONLY'), 'Session cookies must be HttpOnly'
        assert app.config.get('SESSION_COOKIE_SAMESITE') == 'Strict', 'Session cookies must be SameSite=Strict'

        print('✅ All CSRF protection requirements verified')
        "

    - name: Test failure scenarios
      run: |
        echo "Testing CSRF failure scenarios..."
        python -c "
        import sys
        sys.path.insert(0, '.')
        from api_server import CSRFProtection
        import secrets

        # Test 1: Invalid token should fail
        session_id = secrets.token_hex(16)
        assert not CSRFProtection.validate_token('invalid', session_id), 'Invalid token accepted!'

        # Test 2: Expired token should fail
        from datetime import datetime, timedelta
        old_timestamp = str(int((datetime.now() - timedelta(hours=2)).timestamp()))
        expired_token = f'{old_timestamp}:{'a'*64}'
        assert not CSRFProtection.validate_token(expired_token, session_id), 'Expired token accepted!'

        # Test 3: Wrong session token should fail
        valid_token = CSRFProtection.generate_token(session_id)
        wrong_session = secrets.token_hex(16)
        assert not CSRFProtection.validate_token(valid_token, wrong_session), 'Token valid for wrong session!'

        print('✅ All failure scenarios handled correctly')
        "

  security-audit:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Run security audit
      run: |
        echo "Auditing CSRF implementation..."

        # Check for insecure patterns
        if grep -r "csrf.*=.*False" *.py; then
          echo "❌ Found disabled CSRF protection"
          exit 1
        fi

        if grep -r "SameSite.*=.*None" *.py; then
          echo "❌ Found SameSite=None cookies"
          exit 1
        fi

        if grep -r "Secure.*=.*False" *.py; then
          echo "❌ Found insecure cookies"
          exit 1
        fi

        echo "✅ No insecure CSRF patterns found"

    - name: Check for TODO/FIXME in security code
      run: |
        if grep -i "TODO\|FIXME" api_server.py; then
          echo "⚠️  Found TODO/FIXME in security code - review before production"
          exit 1
        fi
        echo "✅ No pending security TODOs"

  integration-tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.11

    - name: Install dependencies
      run: |
        pip install flask flask-cors requests

    - name: Start API server
      run: |
        python api_server.py &
        echo $! > server.pid
        sleep 3
      env:
        FLASK_ENV: testing

    - name: Test CSRF protection endpoints
      run: |
        # Test 1: Get CSRF token
        curl -f http://localhost:5000/api/csrf-token || (echo "❌ CSRF token endpoint failed" && exit 1)

        # Test 2: Health check (no CSRF needed)
        curl -f http://localhost:5000/api/health || (echo "❌ Health check failed" && exit 1)

        echo "✅ Integration tests passed"

    - name: Stop API server
      if: always()
      run: |
        if [ -f server.pid ]; then
          kill $(cat server.pid) || true
        fi

  report:
    runs-on: ubuntu-latest
    needs: [csrf-protection-tests, security-audit, integration-tests]
    if: always()

    steps:
    - name: Report results
      run: |
        echo "======================================"
        echo "SEC-003 CSRF Protection Test Results"
        echo "======================================"
        echo "All test suites completed."
        echo "Check individual job results above."
