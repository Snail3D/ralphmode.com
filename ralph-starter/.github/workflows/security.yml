# SEC-023: Automated Security Scanning
# Comprehensive security scanning pipeline: SAST, DAST, SCA, Container, Secrets
name: Security Scanning Pipeline

on:
  # Run on every PR
  pull_request:
    branches: [ main, develop ]

  # Run on push to main/develop
  push:
    branches: [ main, develop ]

  # Weekly full scan on Sundays at 2 AM UTC
  schedule:
    - cron: '0 2 * * 0'

  # Allow manual trigger
  workflow_dispatch:

# Prevent concurrent scans
concurrency:
  group: security-scan-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # SAST - Static Application Security Testing
  sast-semgrep:
    name: SAST - Semgrep
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/python
          generateSarif: true

      - name: Upload Semgrep results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif

  sast-codeql:
    name: SAST - CodeQL
    runs-on: ubuntu-latest

    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python
          queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

  # SCA - Software Composition Analysis
  sca-snyk:
    name: SCA - Snyk
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/python@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --sarif-file-output=snyk.sarif --severity-threshold=high

      - name: Upload Snyk results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk.sarif

  sca-dependabot:
    name: SCA - Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          vulnerability-check: true
          license-check: true

  # Secrets Scanning
  secrets-gitleaks:
    name: Secrets - GitLeaks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_SUMMARY: true

  secrets-trufflehog:
    name: Secrets - TruffleHog
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  # Container Scanning
  container-trivy:
    name: Container - Trivy
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t ralph-bot:${{ github.sha }} .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ralph-bot:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          vuln-type: 'os,library'
          exit-code: '0'  # Don't fail build, just report

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for CRITICAL vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ralph-bot:${{ github.sha }}
          format: 'table'
          severity: 'CRITICAL'
          exit-code: '1'  # Fail on critical

  container-grype:
    name: Container - Grype
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t ralph-bot:${{ github.sha }} .

      - name: Run Grype vulnerability scanner
        uses: anchore/scan-action@v3
        id: grype
        with:
          image: ralph-bot:${{ github.sha }}
          fail-build: false
          severity-cutoff: high

      - name: Upload Grype SARIF report
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: ${{ steps.grype.outputs.sarif }}

  # DAST - Dynamic Application Security Testing (on staging)
  dast-zap:
    name: DAST - OWASP ZAP
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    services:
      app:
        image: python:3.11
        options: >-
          --health-cmd "curl -f http://localhost:5000/api/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Start application in background
        run: |
          python ralph_bot.py &
          echo $! > app.pid
          sleep 10
        env:
          TELEGRAM_BOT_TOKEN: test_token
          GROQ_API_KEY: test_key

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:5000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'

      - name: Stop application
        if: always()
        run: |
          if [ -f app.pid ]; then
            kill $(cat app.pid) || true
          fi

  # Python-specific security checks
  python-bandit:
    name: Python - Bandit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Bandit
        run: pip install bandit[toml]

      - name: Run Bandit
        run: |
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -f screen

      - name: Upload Bandit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-report
          path: bandit-report.json

  python-safety:
    name: Python - Safety
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Safety
        run: pip install safety

      - name: Check dependencies with Safety
        run: |
          if [ -f requirements.txt ]; then
            safety check --file requirements.txt --output json > safety-report.json || true
            safety check --file requirements.txt
          fi

      - name: Upload Safety results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: safety-report
          path: safety-report.json

  # License compliance
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-licenses
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Check licenses
        run: |
          pip-licenses --format=json --output-file=licenses.json
          pip-licenses --format=markdown --output-file=licenses.md

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: |
            licenses.json
            licenses.md

  # Aggregate results and determine build status
  security-gate:
    name: Security Gate - Fail on Critical
    runs-on: ubuntu-latest
    needs:
      - sast-semgrep
      - sast-codeql
      - secrets-gitleaks
      - secrets-trufflehog
      - container-trivy
      - python-bandit
      - python-safety

    if: always()

    steps:
      - name: Check job results
        run: |
          echo "Checking security scan results..."

          # Check if any critical jobs failed
          if [ "${{ needs.sast-semgrep.result }}" == "failure" ] || \
             [ "${{ needs.sast-codeql.result }}" == "failure" ] || \
             [ "${{ needs.secrets-gitleaks.result }}" == "failure" ] || \
             [ "${{ needs.secrets-trufflehog.result }}" == "failure" ] || \
             [ "${{ needs.container-trivy.result }}" == "failure" ]; then
            echo "âŒ Critical security findings detected!"
            echo "Review the security alerts in the Security tab."
            exit 1
          fi

          echo "âœ… All critical security checks passed"

  # Weekly comprehensive report
  weekly-report:
    name: Weekly Security Report
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    needs:
      - sast-semgrep
      - sast-codeql
      - sca-snyk
      - secrets-gitleaks
      - secrets-trufflehog
      - container-trivy
      - container-grype
      - python-bandit
      - python-safety
      - license-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate comprehensive report
        run: |
          cat > security-report.md << 'EOF'
          # Weekly Security Scan Report

          **Date**: $(date -u +"%Y-%m-%d %H:%M UTC")
          **Commit**: ${{ github.sha }}
          **Branch**: ${{ github.ref_name }}

          ## Scan Results Summary

          | Tool | Status |
          |------|--------|
          | Semgrep (SAST) | ${{ needs.sast-semgrep.result }} |
          | CodeQL (SAST) | ${{ needs.sast-codeql.result }} |
          | Snyk (SCA) | ${{ needs.sca-snyk.result }} |
          | GitLeaks (Secrets) | ${{ needs.secrets-gitleaks.result }} |
          | TruffleHog (Secrets) | ${{ needs.secrets-trufflehog.result }} |
          | Trivy (Container) | ${{ needs.container-trivy.result }} |
          | Grype (Container) | ${{ needs.container-grype.result }} |
          | Bandit (Python) | ${{ needs.python-bandit.result }} |
          | Safety (Python) | ${{ needs.python-safety.result }} |
          | License Check | ${{ needs.license-check.result }} |

          ## Action Items

          Review detailed findings in:
          - GitHub Security tab â†’ Code scanning alerts
          - Artifact downloads from this workflow run

          ## Recommendations

          1. Address all CRITICAL and HIGH severity findings
          2. Review and triage MEDIUM severity findings
          3. Update dependencies with known vulnerabilities
          4. Verify no secrets detected in code
          5. Ensure container images are up to date

          EOF

          cat security-report.md

      - name: Upload weekly report
        uses: actions/upload-artifact@v4
        with:
          name: weekly-security-report
          path: security-report.md

      - name: Create issue for report (if findings exist)
        uses: actions/github-script@v7
        if: needs.security-gate.result == 'failure'
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”’ Weekly Security Scan - Action Required',
              body: `Security scan completed with findings requiring attention.\n\nSee workflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['security', 'urgent']
            })
