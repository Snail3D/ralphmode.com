{
  "description": "SEC-014: DDoS Protection Configuration for Ralph Mode",
  "version": "1.0.0",
  "domain": "ralphmode.com",

  "cloudflare_settings": {
    "description": "Cloudflare provides enterprise-grade DDoS protection, bot detection, and traffic filtering",

    "security_level": {
      "setting": "high",
      "description": "Challenge suspicious visitors. Options: off, essentially_off, low, medium, high, under_attack",
      "recommendation": "Use 'high' normally, 'under_attack' during active DDoS"
    },

    "challenge_passage": {
      "setting": 900,
      "description": "How long (in seconds) a visitor can access your site after completing a challenge (900 = 15 minutes)"
    },

    "browser_integrity_check": {
      "setting": true,
      "description": "Evaluate HTTP headers from your visitors browser for threats. Blocks known malicious browsers."
    },

    "ddos_protection": {
      "l3_l4_protection": {
        "enabled": true,
        "description": "Network-layer DDoS protection (SYN floods, UDP floods, etc.)",
        "details": "Cloudflare automatically detects and mitigates L3/L4 attacks"
      },

      "l7_protection": {
        "enabled": true,
        "description": "Application-layer DDoS protection (HTTP floods)",
        "rate_limiting_rules": [
          {
            "name": "Global HTTP flood protection",
            "description": "Limit requests per IP to prevent HTTP floods",
            "threshold": "1000 requests per minute per IP",
            "action": "challenge"
          },
          {
            "name": "Auth endpoint protection",
            "description": "Extra protection for authentication endpoints",
            "path": "/api/auth/*",
            "threshold": "10 requests per minute per IP",
            "action": "block"
          },
          {
            "name": "API rate limiting",
            "description": "Protect API endpoints from abuse",
            "path": "/api/*",
            "threshold": "100 requests per minute per IP",
            "action": "challenge"
          }
        ]
      },

      "traffic_spike_alerting": {
        "enabled": true,
        "description": "Alert when traffic spikes indicate potential DDoS",
        "threshold": "5x normal traffic",
        "notification_email": "alerts@ralphmode.com"
      }
    },

    "bot_management": {
      "bot_fight_mode": {
        "enabled": true,
        "description": "Automatically blocks known malicious bots and challenges likely bots"
      },

      "verified_bots": {
        "enabled": true,
        "description": "Allow verified good bots (Googlebot, etc.) to bypass challenges",
        "allowed_bots": [
          "Googlebot",
          "Bingbot",
          "Slackbot",
          "Twitterbot"
        ]
      },

      "super_bot_fight_mode": {
        "enabled": true,
        "description": "Enhanced bot detection using machine learning (Business plan+)",
        "action": "challenge",
        "detect_anomalies": true
      }
    },

    "firewall_rules": [
      {
        "name": "Block known bad IPs",
        "description": "Block IPs from Cloudflare threat intelligence",
        "expression": "(cf.threat_score gt 10)",
        "action": "block"
      },
      {
        "name": "Challenge suspicious countries",
        "description": "Challenge traffic from high-risk countries (optional - customize as needed)",
        "expression": "(ip.geoip.country in {\"CN\" \"RU\" \"KP\"})",
        "action": "challenge",
        "enabled": false,
        "note": "Disabled by default - enable only if needed, may affect legitimate users"
      },
      {
        "name": "Block SQL injection attempts",
        "description": "Block common SQL injection patterns",
        "expression": "(http.request.uri.query contains \"' OR 1=1\" or http.request.uri.query contains \"UNION SELECT\")",
        "action": "block"
      },
      {
        "name": "Rate limit login attempts",
        "description": "Prevent brute force attacks on login",
        "expression": "(http.request.uri.path eq \"/api/auth/login\")",
        "action": "challenge",
        "rate_limit": "5 per minute"
      }
    ],

    "geo_blocking": {
      "enabled": false,
      "description": "Block or challenge specific countries (use with caution)",
      "blocked_countries": [],
      "note": "Only enable if you have specific geographic restrictions. Most apps should serve global users."
    },

    "waf": {
      "enabled": true,
      "description": "Web Application Firewall - OWASP ruleset",
      "managed_rules": {
        "cloudflare_managed_ruleset": {
          "enabled": true,
          "description": "Cloudflare's curated security rules"
        },
        "owasp_core_ruleset": {
          "enabled": true,
          "description": "OWASP ModSecurity Core Rule Set",
          "paranoia_level": 1,
          "note": "Level 1 = balanced security and false positives"
        }
      }
    }
  },

  "dns_configuration": {
    "description": "DNS settings for DDoS protection",

    "proxied_records": {
      "enabled": true,
      "description": "Orange cloud = traffic goes through Cloudflare for protection",
      "records": [
        {
          "type": "A",
          "name": "@",
          "value": "69.164.201.191",
          "proxied": true,
          "note": "Root domain proxied through Cloudflare"
        },
        {
          "type": "A",
          "name": "www",
          "value": "69.164.201.191",
          "proxied": true,
          "note": "WWW subdomain proxied through Cloudflare"
        }
      ]
    },

    "anycast_dns": {
      "enabled": true,
      "description": "Cloudflare automatically provides Anycast DNS for distributed entry points",
      "nameservers": [
        "ns1.cloudflare.com",
        "ns2.cloudflare.com"
      ]
    }
  },

  "origin_protection": {
    "description": "Hide origin server IP to prevent direct attacks",

    "hide_origin_ip": {
      "enabled": true,
      "description": "Origin IP hidden behind Cloudflare proxy",
      "origin_ip": "69.164.201.191",
      "note": "NEVER expose this IP in DNS records, code, or documentation"
    },

    "authenticated_origin_pulls": {
      "enabled": true,
      "description": "Require Cloudflare client certificate for origin connections",
      "certificate_path": "/etc/ssl/cloudflare/origin-pull-cert.pem",
      "note": "Configure nginx to require this certificate"
    },

    "firewall_rules_at_origin": {
      "description": "Firewall rules on origin server (Linode) to only allow Cloudflare IPs",
      "allow_cloudflare_ips_only": true,
      "cloudflare_ip_ranges": [
        "https://www.cloudflare.com/ips-v4",
        "https://www.cloudflare.com/ips-v6"
      ],
      "note": "Update firewall rules regularly to match Cloudflare's IP ranges"
    }
  },

  "ssl_tls": {
    "mode": "Full (strict)",
    "description": "Encrypt traffic between Cloudflare and origin",
    "options": [
      "Off - No encryption (NEVER use)",
      "Flexible - Cloudflare to visitor only (insecure origin)",
      "Full - Encrypt all traffic (self-signed cert OK)",
      "Full (strict) - Encrypt all + verify cert (RECOMMENDED)"
    ],
    "origin_certificate": {
      "type": "Cloudflare Origin Certificate",
      "validity": "15 years",
      "install_location": "/etc/ssl/cloudflare/",
      "note": "Free certificate from Cloudflare for origin server"
    }
  },

  "performance_settings": {
    "description": "Performance features that also help with DDoS mitigation",

    "caching": {
      "enabled": true,
      "description": "Cache static content to reduce origin load",
      "cache_level": "standard",
      "browser_cache_ttl": 14400
    },

    "minification": {
      "enabled": true,
      "html": true,
      "css": true,
      "js": true
    },

    "brotli_compression": {
      "enabled": true,
      "description": "Compress responses to reduce bandwidth"
    },

    "http2_http3": {
      "http2": true,
      "http3": true,
      "description": "Modern protocols for better performance"
    }
  },

  "monitoring_and_alerts": {
    "description": "Real-time monitoring and alerting for DDoS attacks",

    "analytics": {
      "enabled": true,
      "description": "Cloudflare Analytics shows traffic patterns and threats",
      "metrics": [
        "Requests per second",
        "Bandwidth",
        "Threats blocked",
        "Bot traffic",
        "Country distribution"
      ]
    },

    "notifications": {
      "enabled": true,
      "channels": [
        {
          "type": "email",
          "address": "alerts@ralphmode.com",
          "events": [
            "DDoS attack detected",
            "High threat level",
            "Origin server unreachable",
            "SSL certificate expiring"
          ]
        },
        {
          "type": "webhook",
          "url": "https://ralphmode.com/api/cloudflare-webhook",
          "description": "Send alerts to Ralph Mode for in-app notifications"
        }
      ]
    },

    "traffic_spike_detection": {
      "enabled": true,
      "description": "Alert when traffic exceeds baseline",
      "threshold_multiplier": 5,
      "baseline_window": "7 days"
    }
  },

  "setup_instructions": {
    "step_1": {
      "title": "Create Cloudflare Account",
      "url": "https://dash.cloudflare.com/sign-up",
      "description": "Sign up for Cloudflare (Free plan includes DDoS protection)"
    },

    "step_2": {
      "title": "Add Domain to Cloudflare",
      "steps": [
        "Click 'Add a Site' in Cloudflare dashboard",
        "Enter ralphmode.com",
        "Select Free plan (includes DDoS protection) or Pro/Business for enhanced features",
        "Cloudflare will scan your existing DNS records"
      ]
    },

    "step_3": {
      "title": "Update Nameservers at GoDaddy",
      "steps": [
        "Log into GoDaddy: https://dcc.godaddy.com",
        "Go to Domain Settings → Nameservers",
        "Change from GoDaddy nameservers to Cloudflare nameservers",
        "Cloudflare will provide nameservers like: ns1.cloudflare.com, ns2.cloudflare.com",
        "Save changes (propagation takes 15 min - 48 hours)"
      ]
    },

    "step_4": {
      "title": "Configure DNS Records in Cloudflare",
      "steps": [
        "In Cloudflare DNS settings, add A records:",
        "  - Type: A, Name: @, Value: 69.164.201.191, Proxy: ON (orange cloud)",
        "  - Type: A, Name: www, Value: 69.164.201.191, Proxy: ON (orange cloud)",
        "Orange cloud = traffic goes through Cloudflare for DDoS protection"
      ]
    },

    "step_5": {
      "title": "Enable Security Features",
      "steps": [
        "Security → Settings → Security Level = High",
        "Security → Bots → Bot Fight Mode = ON",
        "SSL/TLS → Overview → Mode = Full (strict)",
        "SSL/TLS → Edge Certificates → Always Use HTTPS = ON",
        "Firewall → Tools → Rate Limiting = Configure rules from cloudflare_config.json"
      ]
    },

    "step_6": {
      "title": "Configure Origin Firewall (Linode)",
      "description": "Only allow Cloudflare IPs to connect to origin server",
      "commands": [
        "# Download Cloudflare IP ranges",
        "curl https://www.cloudflare.com/ips-v4 -o /tmp/cf-ips-v4.txt",
        "curl https://www.cloudflare.com/ips-v6 -o /tmp/cf-ips-v6.txt",
        "",
        "# Configure ufw to only allow Cloudflare IPs",
        "ufw default deny incoming",
        "ufw default allow outgoing",
        "ufw allow 22/tcp  # SSH - restrict to your IP if possible",
        "",
        "# Allow Cloudflare IPs only for HTTP/HTTPS",
        "for ip in $(cat /tmp/cf-ips-v4.txt); do ufw allow from $ip to any port 80 proto tcp; done",
        "for ip in $(cat /tmp/cf-ips-v4.txt); do ufw allow from $ip to any port 443 proto tcp; done",
        "",
        "ufw enable"
      ]
    },

    "step_7": {
      "title": "Test DDoS Protection",
      "tests": [
        "Visit https://ralphmode.com - should work normally",
        "Check Cloudflare Analytics for traffic going through proxy",
        "Verify origin IP is hidden: dig ralphmode.com should show Cloudflare IPs",
        "Test rate limiting: make rapid requests to /api/auth/login",
        "Enable 'Under Attack Mode' temporarily to test challenge page"
      ]
    },

    "step_8": {
      "title": "Configure Monitoring",
      "steps": [
        "Notifications → Add notification",
        "Configure email alerts for DDoS attacks and high threat scores",
        "Set up webhook to Ralph Mode API for real-time alerts"
      ]
    }
  },

  "under_attack_mode": {
    "description": "Emergency mode during active DDoS attack",
    "how_to_enable": "Security → Settings → Security Level = I'm Under Attack",
    "what_it_does": [
      "Shows JavaScript challenge to all visitors",
      "Blocks most automated attacks",
      "May inconvenience legitimate users (use temporarily)",
      "Rate limits become more aggressive"
    ],
    "when_to_use": [
      "Active DDoS attack in progress",
      "Traffic spikes causing origin server issues",
      "Sustained bot attacks",
      "Layer 7 HTTP floods"
    ],
    "disable_when": "Attack subsides and traffic normalizes"
  },

  "cost_analysis": {
    "free_plan": {
      "cost": "$0/month",
      "includes": [
        "Unmetered DDoS mitigation (L3/L4 and L7)",
        "Basic bot detection",
        "Universal SSL",
        "Cloudflare CDN",
        "Analytics",
        "3 page rules"
      ],
      "suitable_for": "Most small to medium sites"
    },

    "pro_plan": {
      "cost": "$20/month",
      "includes": [
        "Everything in Free",
        "20 page rules",
        "WAF (Web Application Firewall)",
        "Better analytics",
        "Mobile optimization"
      ],
      "suitable_for": "Production apps with higher traffic"
    },

    "business_plan": {
      "cost": "$200/month",
      "includes": [
        "Everything in Pro",
        "Advanced DDoS protection",
        "100 page rules",
        "Custom SSL certificates",
        "24/7 email support",
        "PCI compliance support"
      ],
      "suitable_for": "Enterprise apps, e-commerce"
    },

    "recommendation": "Start with Free plan, upgrade to Pro if you need WAF and better analytics"
  },

  "compliance_notes": {
    "pci_dss": "Cloudflare Business plan required for PCI DSS compliance",
    "gdpr": "Cloudflare is GDPR compliant - Data Processing Addendum available",
    "hipaa": "Contact Cloudflare for HIPAA-compliant enterprise plan",
    "soc2": "Cloudflare is SOC 2 Type II certified"
  },

  "references": {
    "cloudflare_docs": "https://developers.cloudflare.com/ddos-protection/",
    "cloudflare_ip_ranges": "https://www.cloudflare.com/ips/",
    "rate_limiting_guide": "https://developers.cloudflare.com/waf/rate-limiting-rules/",
    "firewall_rules": "https://developers.cloudflare.com/firewall/",
    "analytics_dashboard": "https://dash.cloudflare.com/analytics"
  }
}
