# SEC-017: Container Security - Docker Compose Configuration
version: '3.8'

services:
  ralph-bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ralph-bot
    restart: unless-stopped

    # Security: Read-only root filesystem
    read_only: true

    # Security: Temporary filesystems for runtime data
    tmpfs:
      - /tmp:noexec,nosuid,nodev,size=100m
      - /app/logs:noexec,nosuid,nodev,size=500m

    # Security: No privileged mode
    privileged: false

    # Security: Drop all capabilities
    cap_drop:
      - ALL

    # Security: No new privileges
    security_opt:
      - no-new-privileges:true

    # Security: Resource limits to prevent DoS
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Environment variables from .env file
    env_file:
      - .env

    # Volumes for persistent data (mounted read-write as needed)
    volumes:
      # Mount data directory for SQLite and other persistent storage
      - ralph-data:/app/data:rw
      # Mount logs with rotation
      - ralph-logs:/app/logs:rw

    # Network configuration
    networks:
      - ralph-network

    # Logging configuration
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  # Optional: Redis service for rate limiting (SEC-011)
  redis:
    image: redis:7-alpine
    container_name: ralph-redis
    restart: unless-stopped

    # Security: Read-only root filesystem
    read_only: true

    # Security: Run as non-root
    user: "999:999"

    # Security: No privileged mode
    privileged: false

    # Security: Drop all capabilities
    cap_drop:
      - ALL

    # Security: No new privileges
    security_opt:
      - no-new-privileges:true

    # Security: Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

    # Volumes for Redis data
    volumes:
      - redis-data:/data:rw

    # Network configuration
    networks:
      - ralph-network

    # Redis configuration
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-changeme}

    # Logging
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

    # Health check
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3

# Volumes for persistent data
volumes:
  ralph-data:
    driver: local
  ralph-logs:
    driver: local
  redis-data:
    driver: local

# Network isolation
networks:
  ralph-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
